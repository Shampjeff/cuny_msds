---
title: "Tidy Data - Project 2 Part 1 - Bank Stocks"
author: "Jeff Shamp"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: vignette
---

```{r, include=FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(stringr)
library(RCurl)
```

Using **tidyr, dplyr, ggplot2, stringr, RCurl**

# Tidy Data

I will be using the data source from data I posted since I never had to tidy it (thanks to python/pandas).

## Load Data
```{r}
b<-getURL(
"https://raw.githubusercontent.com/Shampjeff/cuny_msds/master/DATA_607/data/banks.csv")
df_banks<-read.csv(text=b, stringsAsFactors = F)
```

Let's look initial state of the data. 

```{r, warning=FALSE}
kableExtra::kable(df_banks[1:5,1:5]) %>% kableExtra::kable_styling(full_width = F)
```

Got our work cut out for us. Let's start with the banks. The below function cycles through the columns and renames each selected column with a name that is located in one of the rows. many multi-index or nested column structures will have a name buried in a row value. `name_join` is an option to keep the letters of a column name and remove the `xxx.1` naming convention that R uses for duplicate column names. 

```{r}
rename.columns<-function(df, row_idx, col_start, name_join=F){
  for (i in col_start:ncol(df)){                                
    prefix<-c(str_remove(names(df[i]), "[.]\\d"), df[row_idx,i])
    join_name<-paste(prefix, collapse="_")  
    if (name_join == FALSE){
      names(df)[names(df) == names(df[i])]<-df[row_idx,i]
    } else {
      names(df)[names(df) == names(df[i])]<-join_name
    }
  }
  return(df)
}
```


## Bank Stocks 2006

This is data regarding bank stocks from 2006 so it can give a nice window into how these banks were doing before the crash of 2007/08. In this data set there are only six banks listed BAC, C, GS, MS, JPM, and WFC. Each bank has the same varibles associated to them; open, high, low, close, and volume. There is also a date for each bank. 


```{r, warning=FALSE}
df_banks<-rename.columns(df_banks, 1, 2, name_join = TRUE)
df_banks<-df_banks %>%
  slice(3:dim(df_banks)[1]) %>%             # drop unnecessary lines
  rename(Date = Bank.Ticker) %>%
  pivot_longer(-Date, names_to = "bank",
               values_to = "value") %>%      # reshape banks to one column
  separate(bank, c("bank", "status"),
           sep = "_") %>%                    # separate status (open, close, etc.)
  mutate_at(.vars = vars(value),
            .funs = as.numeric) %>%          # Change data types
  mutate_at(.vars = vars(Date),
            .funs = as.Date)

DT::datatable(df_banks,
         extensions = c('FixedColumns',"FixedHeader"),
          options = list(scrollX = TRUE,
                         paging=TRUE,
                         fixedHeader=TRUE))

```

## Analysis

The discussion piece talks about viewing the closing price as a function of time to see who fared better during that time period. The results are below. 

```{r}
df_banks %>%
  filter(status=="Close") %>%
  ggplot() +
  geom_line(aes(x=Date, y=value, col=bank)) +
  labs(x="Date", y="Closing Value", title = "Bank Stock Closing Value 2006 - 2016")
```

Brutal. Citi absolutely tanked. Let's look between 01-01-2008 and 01-01-2010.

```{r}
df_banks %>%
  filter(status=="Close") %>%
  filter(Date >="2008-01-01" & Date <= "2010-01-01") %>%
  ggplot() +
  geom_line(aes(x=Date, y=value, col=bank)) +
  labs(x="Date", y="Closing Value", title = "Bank Stock Closing Value 2008 - 2010")
```

Interesting, by the time Citi hit rock bottom (and never regained!) Goldman Sacks had already recovered most of its pre-collapse value. For all the others listed this time period was not as catastrophic as it seemed. 



